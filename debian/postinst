#!/bin/sh -x
# postinst script for ${packageroot}
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package

# Source debconf library.
. /usr/share/debconf/confmodule

case "$1" in
    configure)
	. /etc/bit9/bit9-core/configure

	packageroot=bit9
	package=bit9-postfix

	# override all default postfix configuration prefs
	mv /etc/postfix/main.cf /etc/postfix/main.cf.bak || true
	ln -s /etc/$packageroot/$package/postfix/main.cf /etc/postfix/main.cf

	# link to virtual config parameters
	db_set $packageroot/UID $(id -u $(db_get $packageroot/VMAIL;echo $RET))
	varsubst $packageroot /etc/$packageroot/$package/postfix/virtual/uid medium
	db_set $packageroot/GID $(id -u $(db_get $packageroot/VMAIL;echo $RET))
	varsubst $packageroot /etc/$packageroot/$package/postfix/virtual/gid medium
	ln -s /etc/$packageroot/$package/postfix/virtual /etc/postfix/virtual

	# link to virtual mail box root
	install -dD -o vmail -g vmail /var/$packageroot/$package/mail/virtual 
	ln -s /var/$packageroot/$package/mail/virtual /var/mail/virtual

	# override the sasl auth config to use preferred auth mechanism
	mv /etc/default/saslauthd /etc/default/saslauthd.bak || true
	ln -s /etc/$packageroot/$package/default/saslauthd /etc/default/saslauthd

        pass=$(db_input high $packageroot/SMTPKEYPASS;db_go;echo $RET)

        db_stop

        openssl genrsa -des3 -passout pass:$pass -out /etc/ssl/private/smtpd.key 2048
        openssl req -new -passin pass:$pass -key /etc/ssl/private/smtpd.key -subj "/C=US/ST=Texas/L=Austin/O=Global Security/OU=IT Department/CN=bit9.io" | openssl x509 -req -days 365 -passin pass:$pass -signkey /etc/ssl/private/smtpd.key -out /etc/ssl/certs/smtpd.crt

	#build db's now
	postmap /etc/$packageroot/$package/postfix/virtual/addresses
	postmap /etc/$packageroot/$package/postfix/virtual/mailbox
	postmap /etc/$packageroot/$package/postfix/virtual/uid
	postmap /etc/$packageroot/$package/postfix/virtual/gid
	postmap /etc/$packageroot/$package/postfix/sender_access

        service postfix restart
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
